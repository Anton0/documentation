{{ define "api-main" }}

    {{ with .Content}}
        {{ . }}
    {{ end }}

    {{ $dot := . }}

    {{ .Scratch.Set "apiVersion" "v1"}}

    {{ if in .Permalink "api/v2" }}
        {{ .Scratch.Set "apiVersion" "v2"}}
    {{ end }}

    {{ $apiVersion := .Scratch.Get "apiVersion"}}

    {{ $d := index $dot.Site.Data.api $apiVersion "full_spec_deref" }}

    {{ $schemaJson := getJSON "./data/api/v1/full_spec_deref.json" }}

    {{ $snipdir := print "content/en/api/" $apiVersion "/examples/" }}

    {{- $files := readDir $snipdir -}}

    {{ range $k, $v := (index $d "tags") }}
        {{ if eq $.Params.title $v.name }}

            {{ $.Scratch.Set "tagObject" (slice)}}

            {{/* build an array of objects for each path, group by tag name */}}
            {{ range $path_key, $path_object := $d.paths }}
                {{ range $action_type, $action := $path_object }}
                    {{ if in $action.tags $v.name }}

                        {{ $.Scratch.Add "tagObject" (dict "pathObject" $path_object "pathKey" $path_key "actionType" $action_type "action" $action ) }}

                    {{ end }}
                {{ end }}
            {{ end }}

            {{ $tagObject := $.Scratch.Get "tagObject"  }}

            <h1>{{ $v.name }}</h1>
            <p>{{ $v.description | markdownify}}</p>
            
            {{/* sort by action summary */}}
            {{ range sort $tagObject ".action.summary" "asc"  }}
                {{ $context := .}}
                <div class="row">
                    <div class="col-12 col-lg-7">
                        <h2 class="mb-2" id="{{ .action.summary | urlize }}">
                            <a href="#{{ .action.summary | urlize }}">{{- .action.summary -}}</a>
                        </h2>
                        <p class="mb-0"><span style="padding: 3px" class="text-uppercase font-semibold text-api-{{ .actionType }} bg-bg-api-{{ .actionType }}">{{ .actionType }}</span>&nbsp;<span>{{.pathKey}}</span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9">
                        <h3 class="mt-2">Overview</h3>
                        <p>{{.action.description | markdownify }}</p>
                        {{ if .action.parameters }}
                            <h3>Arguments</h3>
                            <ul class="list-unstyled">
                                {{ range .action.parameters }}
                                    <li><code>{{ .name }}</code>[<em>{{ cond (eq .required false) "optional" "required" }}</em>]&nbsp;{{ .description | markdownify }}</li>
                                {{ end }}
                            </ul>
                        {{ end }}

                        {{ if .action.requestBody }}

                            <h3 class="mt-2 mb-3">Request</h3>
                            
                            <h4 class="text-capitalize mt-0 mb-1 py-0">Body Data <span class='text-capitalize'>{{ cond (eq .action.requestBody.required true) "(required)" "" }}</span></h4>

                            <p>{{ .action.requestBody.description | markdownify }}</p>

                            {{ if .action.requestBody }}
                            <div class="tab-content">
                                {{ range $content := .action.requestBody.content }}
                                    {{ range $schema := $content }}
                                        {{ if $schema }}

                                        <!-- Get Json and HTML -->
                                        {{ $dot.Scratch.Set "json" "" }}
                                        {{ $dot.Scratch.Set "html" "" }}
                                        {{ with $dot.Resources.Match "examples.json" }}
                                            {{ range . }}
                                              {{ $data := . | unmarshal}}
                                              {{ $req := (index (index $data $context.action.operationId) "request") }}
                                              {{ if $req }}
                                                  {{ $data2 := (index $req "json") | jsonify }}
                                                  {{ $data3 := (replace (replace (replace $data2 "," ",\n") "{" "{\n") "}" "\n}") }}
                                                  {{ $dot.Scratch.Set "json" (highlight $data3 "json" "") }}
                                                  {{ $dot.Scratch.Set "html" (index $req "html") }}
                                              {{ else }}
                                                  {{ warnf "Could not load html/json request for %q" $context.action.operationId }}
                                              {{ end }}
                                            {{ end }}
                                        {{ end }}
                                        {{ $json := ($dot.Scratch.Get "json") }}
                                        {{ $html := ($dot.Scratch.Get "html") }}

                                        {{ with $schema.description }}
                                            <p>{{ . }}</p>
                                        {{ end }}

                                        <ul class="nav nav-tabs border-none response-toggle">
                                            <li class="nav-item">
                                                <a class="nav-link mr-1  js-model-link active" role="tab" href="#" data-toggle="tab">Model</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link mr-1  js-example-link" role="tab" href="#" data-toggle="tab">Example</a>
                                            </li>                     
                                        </ul>
                                      
                                        <div class="tab-content">
                                            <div role="tabpanel" class="tab-pane active js-tab-model" id="{{ $context.action.operationId }}-request-model">
                                              {{ $html | safeHTML }}
                                            </div>
                                            <div role="tabpanel" class="tab-pane js-tab-example" id="{{ $context.action.operationId }}-request-example">
                                              {{ $json }}
                                            </div>
                                        </div>
                                        {{ end }}
                                    {{ end }}
                                {{ end }}
                            </div>
                            {{ end }}    
                        {{ end }}

                        <h3 class="mt-3 mb-2">Response</h3>                            

                        <ul class="nav nav-tabs border-none response-toggle" style="z-index: 10;">
                            {{ range $response_code, $response := .action.responses }}
                                <li class="nav-item">
                                    <a class="nav-link mr-1  {{ if eq $response_code "200"}}active{{end}}"  href="#{{ $context.action.operationId }}-{{ $response_code }}" role="tab" data-toggle="tab">{{ $response_code }}</a>
                                </li>

                            {{ end }}
                        </ul>

                        <div class="tab-content">
                            {{ range $response_code, $response := .action.responses }}
                            <div role="tabpanel" class="tab-pane {{ if eq $response_code "200"}} active {{end}}" id="{{ $context.action.operationId }}-{{ $response_code }}">
                                {{ range $content := $response.content }}
                                    {{ range $schema := $content }}

                                        <!-- Get Json and HTML -->
                                        {{ $dot.Scratch.Set "json" "" }}
                                        {{ $dot.Scratch.Set "html" "" }}
                                        {{ with $dot.Resources.Match "examples.json" }}
                                            {{ range . }}
                                              {{ $data := . | unmarshal}}
                                              {{ $res := (index (index (index $data $context.action.operationId) "responses") $response_code) }}
                                              {{ if $res }}
                                                  {{ $data2 := (index $res "json") | jsonify }}
                                                  {{ $data3 := (replace (replace (replace $data2 "," ",\n") "{" "{\n") "}" "\n}") }}
                                                  {{ $dot.Scratch.Set "json" (highlight $data3 "json" "") }}
                                                  {{ $dot.Scratch.Set "html" (index $res "html") }}
                                              {{ else }}
                                                  {{ warnf "Could not load html/json response code %q in %q" $response_code $context.action.operationId }}
                                              {{ end }}
                                            {{ end }}
                                        {{ end }}
                                        {{ $json := ($dot.Scratch.Get "json") }}
                                        {{ $html := ($dot.Scratch.Get "html") }}
                                        
                                        <ul class="nav nav-tabs border-none response-toggle">
                                            <li class="nav-item">
                                                <a class="nav-link mr-1  js-model-link active" role="tab" href="#" data-toggle="tab">Model</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link mr-1  js-example-link" role="tab" href="#" data-toggle="tab">Example</a>
                                            </li>                     
                                        </ul>
                                      
                                        <div class="tab-content">
                                            <div role="tabpanel" class="tab-pane active js-tab-model" id="{{ $context.action.operationId }}-{{ $response_code }}-model">
                                               
                                                {{ with $schema.description }}
                                                    <p>{{ . }}</p>
                                                {{ end }}

                                              {{ $html | safeHTML }}

                                            </div>
                                            <div role="tabpanel" class="tab-pane js-tab-example" id="{{ $context.action.operationId }}-{{ $response_code }}-example">
                                                <div class="code-snippet-wrapper js-code-block">
                                                    <div class="code-snippet">
                                                        <div class="code-button-wrapper position-absolute">
                                                            <button class="btn text-primary js-copy-button">Copy</button>
                                                        </div>
                                                        {{ $json }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {{ end }}
                                {{ end }}
                            </div>
                            {{ end }}
                        </div>
                    
                        <h3 class="mb-2">Code Example</h3>

                        {{/* match all Page Resource code examples by operationId */}}
                        {{ with $dot.Resources.Match (printf "%s%s" .action.operationId ".*" ) }}
                        <div class="code-snippet-wrapper" >
                        <form class="form-inline">
                    
                            <div class="form-group">
                                <label for="codeLangSelect" class="sr-only">Code language</label>
                                <select class="form-control js-code-lang-select" id="codeLangSelect">
                                  <option value="bash">Shell</option>
                                  <option value="java">Java</option>
                                  <option value="go">Go</option>
                                </select>
                              </div>
                          </form>
                            {{ range . }}

                                {{ $file_content := .Content }}
                                {{ $file_extension := index (split (path.Ext .) ".") 1 }}
                                {{ $lang := index $dot.Site.Data.highlighting.languages $file_extension }}

                                
                                    
                                        
                                        <div class="code-snippet js-code-block {{if eq $file_extension "sh"}}d-block{{else}}d-none{{end}} code-block-{{ $lang.pygments_name }}" >
                                            <div class="code-button-wrapper position-absolute">
                                                <button class="btn text-primary js-copy-button">Copy</button>
                                            </div>
                                            {{ highlight $file_content $lang.pygments_name "" }}
                                        </div>
                                    
                            {{ end }}
                        </div>

                        {{ end }}

                        {{/* range $files }}

                            {{ .Name }}

                           

                            {{ $file := (print $snipdir (.Name))}}
                            {{ if and (fileExists $file) (not (in $file "openapi-generator" ))  }}
                                {{ $file_content := readFile $file }}
                                {{ $file_basename := (index (split .Name ".") 0) }}
                                {{ $file_extension := index (split (path.Ext $file) ".") 1 }}

                                {{ if eq $context.action.operationId $file_basename }}
                                    {{ $lang := index $dot.Site.Data.highlighting.languages $file_extension }}

                                    <div class="code-snippet-wrapper js-code-block {{if eq $file_extension "sh"}}d-block{{else}}d-none{{end}} code-block-{{ $lang.pygments_name }}">
                                        <div class="code-snippet">
                                      
                                        <div class="code-button-wrapper position-absolute">
                                        <button class="btn text-primary js-copy-button">Copy</button>
                                        </div>
                                       
                                       
                                        {{ highlight $file_content $lang.pygments_name "" }}
                                        </div>
                                        </div>
                                  
                            
                                {{ end }}
                            {{ end }}
                        {{ end */}}
                    </div>
                </div>
                <div class="row" style="margin-top: 90px;">
                    <div class="col-12">
                        <hr class="mt-0 mb-2" style="border-top: 2px solid#DADADA"/>
                    </div>
                </div>
            {{ end }}

            <!-- If endpoint is deprecated -->
            {{ if eq (index $v "x-deprecated") true}}

                <div class="alert alert-danger">
                    {{$v.description | markdownify}}
                    {{$v.externalDocs.description}} <a href="{{$v.externalDocs.url}}">{{$v.externalDocs.url}}</a>
                </div>

            {{ end }}

        {{ end }}
    {{ end }}
{{ end }}
