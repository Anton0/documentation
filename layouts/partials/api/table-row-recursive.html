{{ $dot := .}}

{{ $d := .context.Site.Data.api.v1.full_spec_deref }}

{{ if in .context.Permalink "api/v2" }}
        {{ $d = .context.Site.Data.api.v2.full_spec_deref }}
    {{ end }}

{{ $parentScratch := newScratch }}
{{ $childScratch := newScratch }}

{{ $parentScratch.Set "parent" .parent}}
{{ $parent := $parentScratch.Get "parent"}}

{{ range $key, $value := .data }}

    {{/*
        We actually only care about properties not items, however properties appear inside items.
        So only pass .items.properties when we have .items
    */}}

    {{ $s := newScratch }}
    {{ if reflect.IsMap $value }}
      {{ with $value.properties }}
        {{ $s.Set "data" . }}
      {{ end }}
      {{ with $value.items }}
          {{ if reflect.IsMap . }}
            {{ with .properties }}
              {{ $s.Set "data" . }}
            {{ else }}
              {{ $s.Set "data" . }}
            {{ end }}
          {{ end }}
      {{ end }}
    {{ end }}
    {{ $childData := ($s.Get "data") }}

    
    <tr {{ if $childData }} data-toggle="collapse" data-target=".parent-{{$parent}}" {{ end}}  class="{{ if $childData }}  has-nested {{ else }}  {{ end }} {{if eq $dot.isNested true}} parent-{{ $parent }}  collapse {{end}}">
        <td>{{ if $childData }}<span style="cursor: pointer; font-size: 18px">> &nbsp;</span>{{ end }}{{ $key }}</td>
        {{ if reflect.IsMap $value }}

          {{ $readOnly := cond (eq $value.readOnly true ) "R" ""}}
          
          {{ with $value.type }}

            <td>{{ . }}&nbsp;<span class="font-semibold">{{$readOnly}}</span></td>
          {{ end }}
          <td>
            {{ with $value.description }}
              {{ if reflect.IsMap . }}
              {{ else }}
                {{ . | markdownify }}
              {{ end }}
            {{ end }}
          </td>
        {{ else }}
          <td>&nbsp;</td>
          <td>&nbsp;{{ $value }}</td>
        {{ end }}
    </tr>

    {{ if $childData }}
    
    {{ else }}
    {{ $parentScratch.Add "parent" 1}}
    {{ end }}

    {{ $parent = $parentScratch.Get "parent" }}
    
    {{ partial "api/table-row-recursive.html" (dict "context" $dot.context "data" $childData "isNested" true "parent" $parent ) }}

{{ end }}
